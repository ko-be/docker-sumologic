#!/bin/bash

if [ -z ${SUMO_NAME} ] || [ -z ${SUMO_CATEGORY} ]; then
    echo "SUMO_NAME or SUMO_CATEGORY environment variable(s) not set, exiting"
    exit 1
fi 

if [  "true" != "${MULTILINE_PROCESSING}" ]; then
    MULTILINE_PROCESSING="false"
fi

TEMPLATE="{
    \"api.version\": \"v1\",
    \"sources\": [
        {
            \"sourceType\": \"LocalFile\",
            \"name\": \"${SUMO_NAME}\",
            \"pathExpression\": \"/tmp/clogs/**/*.log\",
            \"category\": \"${SUMO_CATEGORY}\",
            \"useAutolineMatching\": ${MULTILINE_PROCESSING},
            \"multilineProcessingEnabled\": ${MULTILINE_PROCESSING}
        }
    ]
}"

echo "Writing /etc/sumo-sources.json:"
echo "${TEMPLATE}"
echo ${TEMPLATE} > /etc/sumo-sources.json

echo "Starting sumologic..."
source /run.sh "$@"
